<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHANNEL MASTER | Final Release Ver.93</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Base Layout */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background-color: #000; color: #fff; padding: 0; margin: 0; user-select: none; overflow: hidden; touch-action: manipulation; display: flex; flex-direction: column; height: 100dvh; }
        
        /* Ad Container */
        #ad-container { width: 100%; height: 50px; background-color: #222; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #444; z-index: 1000; color: #555; font-size: 0.8em; }

        /* Game Container */
        .container { width: 100%; max-width: 420px; margin: 0 auto; padding: 10px 15px; flex-grow: 1; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; position: relative; z-index: 10; background-color: #121212; }
        
        /* UI Components */
        .top-bar { display: flex; justify-content: space-between; padding: 5px 15px; background: #1e1e1e; border-radius: 8px; font-weight: bold; margin-bottom: 5px; border-bottom: 2px solid #ffd700; flex-shrink: 0; }
        .score-val { font-size: 2.5em; font-weight: 800; line-height: 1; color: #fff; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);}
        .enemy-container { position: relative; width: 100%; margin: 25px auto 5px; background: #252525; border-radius: 12px; padding: 10px 0; border: 2px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100px; flex-shrink: 0; }
        .viewer-comment { position: absolute; top: -14px; background: #fff; color: #000; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8em; border: 2px solid #000; white-space: nowrap; z-index: 20;}
        .resource-area { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; background: #1e1e1e; padding: 6px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #333; flex-shrink: 0; }
        .res-item { font-size: 0.9em; font-weight: bold; padding: 4px 0; }
        .res-rate { font-size: 0.75em; color: #ffd700; display: block; margin-top: 2px; }
        
        /* Buttons */
        .item-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .btn-item { padding: 8px; border: none; border-radius: 8px; font-weight: bold; color: white; background: #2f2f35; border-bottom: 3px solid #1a1a1d; font-size: 0.8em; transition: all 0.1s;}
        .btn-item.active { background: linear-gradient(135deg, #5e4c00, #332a00); border: 2px solid #f1c40f; transform: translateY(2px); box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .control-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; height: 85px; flex-shrink: 0;}
        .special-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 85px; flex-shrink: 0;}
        .btn-action { height: 100%; border: none; border-radius: 12px; color: white; cursor: pointer; position: relative; box-shadow: 0 6px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.05s; overflow: hidden; }
        .btn-action:active { transform: translateY(6px); box-shadow: none; margin-bottom: 6px; }
        .btn-main-text { font-size: 10px; font-weight: 900; margin-bottom: 1px; }
        .btn-sub-text { font-size: 9px; font-weight: 900; background: rgba(0,0,0,0.7); padding: 2px 4px; border-radius: 10px; min-width: 90%; white-space: nowrap; }
        
        /* Colors */
        .bg-red { background: linear-gradient(135deg, #ef476f, #d6336c); }
        .bg-blue { background: linear-gradient(135deg, #118ab2, #073b4c); }
        .bg-green { background: linear-gradient(135deg, #06d6a0, #059669); }
        .bg-white { background: linear-gradient(135deg, #f8f9fa, #dee2e6); color: #333; }
        .bg-black { background: linear-gradient(135deg, #9b5de5, #5a189a); }

        /* Overlays & Ranking */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        #title-screen { z-index: 1500; }
        .res-box { background: #1f1f23; padding: 20px; border-radius: 16px; border: 2px solid #ffd700; width: 92%; max-width: 400px; text-align: center; max-height: 85vh; overflow-y: auto; }
        .tab-btn { flex: 1; padding: 8px; background: #222; border: none; color: #888; border-radius: 5px; font-size: 0.8em; font-weight: bold; margin: 0 2px; }
        .tab-btn.active { background: #ffd700; color: #000; }
        .tab-content { display: none; text-align: left; font-size: 0.85em; line-height: 1.4; color: #ccc; }
        .tab-content.active { display: block; }
        .manual-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.75em; }
        .manual-table th, .manual-table td { border: 1px solid #444; padding: 4px; text-align: center; }
        .manual-table th { background: #333; color: #ffd700; }
        .main-btn { margin-top: 10px; padding: 15px; font-size: 1.2em; font-weight: bold; background: linear-gradient(90deg, #ffd700, #e6ac00); color: #000; border: none; border-radius: 10px; width: 100%; cursor: pointer;}
        .sub-btn { margin-top: 5px; padding: 10px; font-size: 0.9em; font-weight: bold; background: #444; color: #fff; border: none; border-radius: 8px; width: 100%; cursor: pointer;}
        .lang-btn { flex: 1; padding: 10px; border-radius: 8px; background: #222; color: #888; border: 2px solid #444; font-weight: bold; }
        .lang-btn.active { color: #fff; border-color: #ffd700; background: #333; }
        .ranking-list { text-align: left; margin-top: 10px; max-height: 300px; overflow-y: auto; font-size: 0.9em; }
        .rank-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; }
        .rank-row:nth-child(1), .rank-row:nth-child(2), .rank-row:nth-child(3) { background: rgba(255,215,0,0.1); }
        .rank-row span { display: inline-block; }
        .rank-num { width: 30px; color: #888; font-weight: bold; }
        .rank-name { flex-grow: 1; text-align: left; padding-left: 10px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-score { color: #ffd700; font-weight: bold; }
        .name-input { width: 80%; padding: 10px; font-size: 1.2em; text-align: center; background: #333; color: #fff; border: 2px solid #ffd700; border-radius: 8px; margin-bottom: 10px; }
        .err-msg { color: #ff6b6b; font-size: 0.8em; margin-bottom: 10px; display: none; }

        /* FX */
        .flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 80; opacity: 0; }
        .flash-anim { animation: screenFlash 0.3s ease-out; }
        @keyframes screenFlash { 0% { background-color: rgba(255, 255, 255, 0.9); opacity: 1; } 100% { background-color: transparent; opacity: 0; } }
        .boost-overlay { position: fixed; top:0; left:0; width:100%; height:100%; border: 4px solid #f1c40f; pointer-events: none; display: none; z-index: 50; box-shadow: inset 0 0 50px rgba(241, 196, 15, 0.4); animation: pulseBorder 0.8s infinite; }
        @keyframes pulseBorder { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .cutin-text { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 4em; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(255,215,0,0.8), 4px 4px 0px #000; z-index: 3000; pointer-events: none; animation: cutInAnim 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes cutInAnim { 0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); } 70% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); } 100% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); opacity: 0; } }
    </style>
</head>
<body>

<div id="ad-container">
    <span>[AD SPACE 320x50]</span>
</div>

<div id="flash-fx" class="flash-overlay"></div>
<div id="boost-fx" class="boost-overlay"></div>

<div id="ranking-overlay" class="overlay" style="display:none; z-index:2500;">
    <div class="res-box">
        <h2 style="color:#ffd700; margin-top:0;">ğŸ† WORLD RANKING</h2>
        <div id="ranking-list" class="ranking-list">Loading...</div>
        <button class="main-btn" onclick="document.getElementById('ranking-overlay').style.display='none'">CLOSE</button>
    </div>
</div>

<div id="name-input-overlay" class="overlay" style="display:none; z-index:2600;">
    <div class="res-box">
        <h2 style="color:#ffd700;">RANK IN!</h2>
        <p>TOP 100ã«å…¥ã‚Šã¾ã—ãŸï¼<br>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <input type="text" id="player-name" class="name-input" placeholder="Your Name" maxlength="10">
        <div id="name-err" class="err-msg">ä¸é©åˆ‡ãªè¨€è‘‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™</div>
        <button class="main-btn" onclick="submitScore()">REGISTER</button>
        <button class="sub-btn" onclick="document.getElementById('name-input-overlay').style.display='none'">SKIP</button>
    </div>
</div>

<div id="manual-overlay" class="overlay" style="display:none;">
    <div class="res-box">
        <h2 style="color:#ffd700; margin-top:0;" id="m-title">éŠã³æ–¹</h2>
        <div style="display:flex; gap:5px; margin-bottom:15px; background:#000; padding:5px; border-radius:8px;">
            <button class="tab-btn active" onclick="showTab(0)" id="t-0">åŸºæœ¬</button>
            <button class="tab-btn" onclick="showTab(1)" id="t-1">æˆ¦ç•¥</button>
            <button class="tab-btn" onclick="showTab(2)" id="t-2">ç‰¹æ®Š</button>
        </div>
        <div id="tab-0" class="tab-content active"></div>
        <div id="tab-1" class="tab-content"></div>
        <div id="tab-2" class="tab-content"></div>
        <button class="main-btn" onclick="closeManual()">CLOSE</button>
    </div>
</div>

<div id="policy-overlay" class="overlay" style="display:none;">
    <div class="res-box">
        <h3 id="p-title">Privacy Policy</h3>
        <div id="p-content" style="text-align:left; font-size:0.8em; line-height:1.4; height:200px; overflow-y:auto; background:#000; padding:10px; border-radius:8px; margin-bottom:10px;"></div>
        <button class="main-btn" onclick="closePolicy()">OK</button>
    </div>
</div>

<div id="title-screen" class="overlay">
    <div class="res-box">
        <div style="font-size:2.5em; font-weight:900;">CHANNEL<br><span style="color:#ffd700">MASTER</span></div>
        <div style="display:flex; gap:10px; margin:15px 0;">
            <button class="lang-btn" id="lang-ja" onclick="setLang('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
            <button class="lang-btn" id="lang-en" onclick="setLang('en')">ğŸ‡ºğŸ‡¸ English</button>
        </div>
        <button class="sub-btn" onclick="openRanking()">ğŸ† RANKING</button>
        <button class="sub-btn" onclick="openManual()" id="btn-manual-lbl">éŠã³æ–¹</button>
        <div style="background:#000; padding:10px; border-radius:8px; margin:5px 0; border:1px solid #333;">
            <div style="font-size:0.8em; color:#888;" id="best-lbl">PERSONAL BEST</div>
            <div style="font-size:1.5em; font-weight:bold; color:#ffd700;">Â¥ <span id="title-hs">0</span></div>
        </div>
        <button class="main-btn" onclick="startGame()" id="btn-start-lbl">é…ä¿¡é–‹å§‹</button>
        <button class="sub-btn" style="background:transparent; border:none; color:#666;" onclick="showPolicy()" id="btn-policy-lbl">Privacy Policy</button>
    </div>
</div>

<div class="container" id="main-container">
    <div class="top-bar"><div>CH MASTER</div><div style="color:#88ccff;"><span id="ui-turn">30</span> <span id="turn-lbl">Turns Left</span></div></div>
    <div class="score-board">
        <div style="font-size:0.8em; color:#ffd700; font-weight:bold;" id="score-lbl">æ¨å®šåç›Š</div>
        <div class="score-val">Â¥<span id="ui-score">0</span></div>
        <div style="color:#f1c40f; font-weight:bold;"><span id="ui-combo">0</span> Buzz Chain!</div>
    </div>
    <div class="enemy-container" id="enemy-box">
        <div class="viewer-comment" id="ui-comment">---</div>
        <div id="ui-enemy-icon" style="font-size:3.2em;">ğŸ”´</div>
        <div id="ui-enemy-name" style="font-weight:bold;">---</div>
        <div style="position:absolute; top:10px; right:10px; background:#333; padding:2px 6px; border-radius:6px; font-size:0.7em;">Lv.<span id="ui-level">1</span></div>
    </div>
    <div class="resource-area">
        <div class="res-item">ğŸ”¥ <span id="ui-res-red">0</span><br><span class="res-rate" id="ui-rate-red">+0.00x</span></div>
        <div class="res-item">â„ï¸ <span id="ui-res-blue">0</span><br><span class="res-rate" id="ui-rate-blue">+0.00x</span></div>
        <div class="res-item">ğŸ€ <span id="ui-res-green">0</span><br><span class="res-rate" id="ui-rate-green">+0.00x</span></div>
        <div style="grid-column: span 3; border-top:1px solid #333; padding-top:4px; font-weight:900;" id="total-lbl">TOTAL Multiplier: x1.00</div>
    </div>
    <div class="item-area">
        <button class="btn-item" onclick="useBooster(event)" id="ui-boost-btn"></button>
        <button class="btn-item" onclick="useRecover(event)" id="ui-time-btn"></button>
    </div>
    <div class="control-panel">
        <button class="btn-action bg-red" onclick="battle('red')"><span id="lbl-btn-red" class="btn-main-text"></span><span id="btn-score-red" class="btn-main-text"></span><span id="btn-lbl-red" class="btn-sub-text"></span></button>
        <button class="btn-action bg-blue" onclick="battle('blue')"><span id="lbl-btn-blue" class="btn-main-text"></span><span id="btn-score-blue" class="btn-main-text"></span><span id="btn-lbl-blue" class="btn-sub-text"></span></button>
        <button class="btn-action bg-green" onclick="battle('green')"><span id="lbl-btn-green" class="btn-main-text"></span><span id="btn-score-green" class="btn-main-text"></span><span id="btn-lbl-green" class="btn-sub-text"></span></button>
    </div>
    <div class="special-row">
        <button class="btn-action bg-white" onclick="battle('white')"><span id="lbl-btn-collab" style="font-size:0.7em;font-weight:900;">ğŸ¤ COLLAB</span><span id="btn-score-white" class="btn-main-text"></span><span id="btn-lbl-white" class="btn-sub-text"></span></button>
        <button class="btn-action bg-black" onclick="battle('black')"><span id="lbl-btn-prank" style="font-size:0.7em;font-weight:900;">ğŸ‘» PRANK</span><span id="btn-score-black" class="btn-main-text"></span><span id="btn-lbl-black" class="btn-sub-text"></span></button>
    </div>
</div>

<div id="result-overlay" class="overlay" style="display:none;">
    <div class="res-box">
        <h2 id="res-title" style="color:#ffd700; border-bottom:1px solid #ffd700; padding-bottom:10px;">çµæœ</h2>
        <div id="ui-res-grid" style="text-align:left; line-height:1.6; font-size:0.85em; padding:10px 0;"></div>
        <hr>
        <div id="res-final-lbl" style="font-size:0.8em; color:#888;">æœ€çµ‚åç›Š</div>
        <div style="font-size:2em; font-weight:900; color:#ffd700;">Â¥ <span id="ui-res-final">0</span></div>
        <button class="main-btn" onclick="shareOnX()" id="share-btn">çµæœã‚’ã‚·ã‚§ã‚¢</button>
        <button class="sub-btn" onclick="backToTitle()" id="back-btn">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
</div>

<script>
    /* ========== FIREBASE CONFIG ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyDoV2brpPvoSZ-n2dZ5zWkKa6Yzwl11Jcc",
      authDomain: "channel-master-ranking.firebaseapp.com",
      projectId: "channel-master-ranking",
      storageBucket: "channel-master-ranking.firebasestorage.app",
      messagingSenderId: "233737131009",
      appId: "1:233737131009:web:50f521fa20b98fc1269c00",
      measurementId: "G-QNF6535VFF"
    };
    /* ===================================== */

    // Init Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch(e) { console.error("Firebase Error", e); }

    // NG Words (Simple Filter)
    const NG_WORDS = ['fuck', 'shit', 'piss', 'bitch', 'ass', 'æ­»ã­', 'æ®ºã™', 'é¦¬é¹¿', 'ã‚¢ãƒ›', 'ã‚­ãƒã‚¬ã‚¤', 'sex', 'porn', 'gm', 'admin', 'é‹å–¶', 'unk', 'chinpo', 'man'];

    // Game Data
    const ENEMY_DATA = [{ id:'red', icon:'ğŸ”¥', color:'#ff6b6b', ja:{name:'ãƒ‘ãƒƒã‚·ãƒ§ãƒ³å‹¢', comment:'ç†±ã„å±•é–‹é ¼ã‚€ï¼'}, en:{name:'Passion Fan', comment:'Make it hot!'}}, { id:'blue', icon:'â„ï¸', color:'#4facfe', ja:{name:'ã‚¯ãƒ¼ãƒ«å‹¢', comment:'å†·é™ãªåˆ†æåŠ©ã‹ã‚‹ã€‚'}, en:{name:'Cool Viewer', comment:'Keep it calm.'}}, { id:'green', icon:'ğŸ€', color:'#43e97b', ja:{name:'ãƒãƒ«å‹¢', comment:'ã¾ã£ãŸã‚Šé›‘è«‡ã€‚'}, en:{name:'Chill Fan', comment:'Relaxing vibes.'}}, { id:'white', icon:'ğŸ¤', color:'#ffffff', ja:{name:'VIPã‚²ã‚¹ãƒˆ', comment:'ã‚³ãƒ©ãƒœå¾…ã£ã¦ã¾ã™ï¼'}, en:{name:'VIP Guest', comment:'Collab please!'}}, { id:'black', icon:'ğŸ‘¾', color:'#a0a0a0', ja:{name:'ãƒãƒ‹ã‚¢', comment:'åˆºæ¿€ãŒæ¬²ã—ã„ã€‚'}, en:{name:'Maniac', comment:'Surprise me!'}}];
    
    // UI STRINGS (Monetization Compliant)
    const UI_STRINGS = {
        ja: {
            manual: "éŠã³æ–¹", start: "é…ä¿¡é–‹å§‹", best: "è‡ªå·±ãƒ™ã‚¹ãƒˆ", turn: "æ  æ®‹ã‚Š", score: "æ¨å®šåç›Š", total: "TOTALå€ç‡", boost: "ğŸ¬ æ‹¡æ•£ãƒ–ãƒ¼ã‚¹ãƒˆ", time: "â° å»¶é•·æ ç”³è«‹", share: "çµæœã‚’ã‚·ã‚§ã‚¢", title: "ã‚¿ã‚¤ãƒˆãƒ«ã¸", result: "é…ä¿¡ãƒªã‚¶ãƒ«ãƒˆ",
            red: "ğŸ”¥ ãƒ‘ãƒƒã‚·ãƒ§ãƒ³", blue: "â„ï¸ ã‚¯ãƒ¼ãƒ«", green: "ğŸ€ ãƒãƒ«", collab: "ğŸ¤ ã‚³ãƒ©ãƒœ", prank: "ğŸ‘» ãƒ‰ãƒƒã‚­ãƒª", policy: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼",
            resBase: "ã‚¹ãƒ‘ãƒãƒ£ç·é¡", resBonus: "æ¡ˆä»¶ãƒœãƒ¼ãƒŠã‚¹", resFinal: "æœ€çµ‚åç›Š",
            pContent: "<p><b>1. æƒ…å ±ã®å–å¾—ã¨åˆ©ç”¨</b><br>å½“ã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®æä¾›ã«ãŠã„ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ã‚¹ã‚³ã‚¢æƒ…å ±ã‚’Firebaseã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ãƒ»ä¿å­˜ã—ã€ã“ã‚Œã‚’å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã—ã¾ã™ã€‚</p><p><b>2. åºƒå‘Šé…ä¿¡ã«ã¤ã„ã¦</b><br>å½“ã‚¢ãƒ—ãƒªã¯Google AdSenseç­‰ã®ç¬¬ä¸‰è€…é…ä¿¡åºƒå‘Šã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚åºƒå‘Šé…ä¿¡äº‹æ¥­è€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«å¿œã˜ãŸåºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«Cookieã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Cookieã‚’ç„¡åŠ¹ã«ã™ã‚‹è¨­å®šã«ã¤ã„ã¦ã¯Googleã®ãƒãƒªã‚·ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p><p><b>3. ã‚¢ã‚¯ã‚»ã‚¹è§£æ</b><br>å½“ã‚¢ãƒ—ãƒªã§ã¯ã€Google Analyticsã‚’åˆ©ç”¨ã—ã¦åˆ©ç”¨çŠ¶æ³ã‚’åé›†ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯åŒ¿åã§åé›†ã•ã‚Œã¦ãŠã‚Šã€å€‹äººã‚’ç‰¹å®šã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p><p><b>4. å…è²¬äº‹é …</b><br>ã‚²ãƒ¼ãƒ å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€Œåç›Šã€ã‚„ã€Œé‡‘é¡ã€ã¯ã‚²ãƒ¼ãƒ æ¼”å‡ºä¸Šã®ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®é‡‘éŠ­ã®æˆå—ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚</p>",
            t0: "åŸºæœ¬", t1: "æˆ¦ç•¥", t2: "ç‰¹æ®Š",
            m0: "<p><b>é…ä¿¡ã®ä»•çµ„ã¿</b></p><p>[ã‚¹ãƒ‘ãƒãƒ£ç·é¡] Ã— [æ¡ˆä»¶å€ç‡] ï¼ æœ€çµ‚åç›Š</p><p>æ¡ˆä»¶(Promo)30ç²å¾—ã”ã¨ã«æœ€çµ‚åç›ŠãŒ+1.0å€ã•ã‚Œã¾ã™ã€‚</p>",
            m1: "<p><b>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¯”è¼ƒ</b></p><table class='manual-table'><tr><th>è¡Œå‹•</th><th>æ¡ˆä»¶æ•°</th><th>ã‚³ãƒ³ãƒœ</th><th>ãƒ‰ãƒ­ãƒƒãƒ—</th></tr><tr><td>Buzz</td><td>+3</td><td>ç¶™ç¶š</td><td>â°é«˜ / ğŸ¬ä½</td></tr><tr><td>Keep</td><td>+6</td><td>ç¶™ç¶š</td><td>ä¸­</td></tr><tr><td>Promo</td><td>+9</td><td>ãƒªã‚»ãƒƒãƒˆ</td><td>â°ä½ / ğŸ¬é«˜</td></tr></table>",
            m2: "<p><b>ç‰¹æ®Šã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</b></p><p>ç‰¹æ®Šãƒœã‚¿ãƒ³(ğŸ¤ğŸ‘»)ã®ã¿å…¨å±æ€§(All)ã«åŠ ç®—ãŒç™ºç”Ÿã—ã¾ã™ã€‚<br>ãƒ»Buzzï¼šAll Promo +1<br>ãƒ»Promoï¼šAll Promo +3</p><p><b>ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœ</b></p><p>ğŸ¬ ãƒ–ãƒ¼ã‚¹ãƒˆ: 1ã‚¿ãƒ¼ãƒ³å£²ä¸Š2å€<br>â° å»¶é•·æ : æ®‹ã‚Šã‚¿ãƒ¼ãƒ³+1</p>"
        },
        en: {
            manual: "HOW TO PLAY", start: "START STREAM", best: "PERSONAL BEST", turn: "Turns Left", score: "EST. REVENUE", total: "TOTAL Multiplier", boost: "ğŸ¬ BOOST", time: "â° TIME", share: "Share Result", title: "Title Screen", result: "Stream Result",
            red: "ğŸ”¥ Passion", blue: "â„ï¸ Cool", green: "ğŸ€ Chill", collab: "ğŸ¤ Collab", prank: "ğŸ‘» Prank", policy: "Privacy Policy",
            resBase: "SuperChat Total", resBonus: "Promo Bonus", resFinal: "Final Revenue",
            pContent: "<p><b>1. Data Collection</b><br>This app stores player names and scores on Firebase servers for the global ranking feature. This data is publicly visible.</p><p><b>2. Advertising</b><br>This app uses third-party advertising services like Google AdSense. Vendors use cookies to serve ads based on your prior visits to this website. You can opt out of personalized advertising by visiting Google's Ad Settings.</p><p><b>3. Analytics</b><br>We use Google Analytics to collect anonymous usage data to improve the app.</p><p><b>4. Disclaimer</b><br>Any 'Revenue' or currency displayed in this game is fictional and for entertainment purposes only.</p>",
            t0: "Basic", t1: "Strategy", t2: "Special",
            m0: "<p><b>How it works</b></p><p>[SuperChat] Ã— [Promo Multiplier] = Revenue</p><p>Every 30 Promo units increase multiplier by +1.0x.</p>",
            m1: "<p><b>Action Chart</b></p><table class='manual-table'><tr><th>Action</th><th>Promo</th><th>Chain</th><th>Drop</th></tr><tr><td>Buzz</td><td>+3</td><td>Keep</td><td>â°High</td></tr><tr><td>Keep</td><td>+6</td><td>Keep</td><td>Mid</td></tr><tr><td>Promo</td><td>+9</td><td>Reset</td><td>ğŸ¬High</td></tr></table>",
            m2: "<p><b>Special Targets</b></p><p>Only special buttons (ğŸ¤ğŸ‘») trigger All Promo gains.<br>ãƒ»Buzz: All Promo +1<br>ãƒ»Promo: All Promo +3</p><p><b>Items</b></p><p>ğŸ¬ Boost: 2x Score for 1 turn<br>â° Time: +1 Turn</p>"
        }
    };

    let curLang = localStorage.getItem('cm_lang') || 'ja';
    let turn, score, combo, level, resources, boostCount, recoverCount, isBoostActive, currentEnemy;
    let finalScoreTemp = 0;
    const Sound = { ctx:null, init() { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; this.ctx = new AudioContext(); } catch(e){} }, play(f, d) { if (!this.ctx) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.frequency.setValueAtTime(f,this.ctx.currentTime); g.gain.setValueAtTime(0.1,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d); } };

    function setLang(l) { curLang = l; localStorage.setItem('cm_lang', l); applyUI(); }
    function applyUI() {
        const s = UI_STRINGS[curLang];
        document.getElementById('btn-manual-lbl').innerText = s.manual; document.getElementById('btn-start-lbl').innerText = s.start; document.getElementById('best-lbl').innerText = s.best;
        document.getElementById('turn-lbl').innerText = s.turn; document.getElementById('score-lbl').innerText = s.score;
        document.getElementById('m-title').innerText = s.manual;
        document.getElementById('t-0').innerText = s.t0; document.getElementById('t-1').innerText = s.t1; document.getElementById('t-2').innerText = s.t2;
        document.getElementById('tab-0').innerHTML = s.m0; document.getElementById('tab-1').innerHTML = s.m1; document.getElementById('tab-2').innerHTML = s.m2;
        document.getElementById('lbl-btn-red').innerText = s.red; document.getElementById('lbl-btn-blue').innerText = s.blue; document.getElementById('lbl-btn-green').innerText = s.green;
        document.getElementById('lbl-btn-collab').innerText = s.collab; document.getElementById('lbl-btn-prank').innerText = s.prank;
        document.getElementById('btn-policy-lbl').innerText = s.policy;
        document.getElementById('lang-ja').className = 'lang-btn' + (curLang === 'ja' ? ' active' : '');
        document.getElementById('lang-en').className = 'lang-btn' + (curLang === 'en' ? ' active' : '');
        if(currentEnemy) updateUI();
    }

    function showTab(i) { document.querySelectorAll('.tab-btn').forEach((b,idx)=>b.className=idx==i?'tab-btn active':'tab-btn'); document.querySelectorAll('.tab-content').forEach((c,idx)=>c.className=idx==i?'tab-content active':'tab-content'); }
    function openManual() { document.getElementById('manual-overlay').style.display='flex'; }
    function closeManual() { document.getElementById('manual-overlay').style.display='none'; }
    function showPolicy() { const s = UI_STRINGS[curLang]; document.getElementById('p-title').innerText = s.policy; document.getElementById('p-content').innerText = s.pContent; document.getElementById('policy-overlay').style.display = 'flex'; }
    function closePolicy() { document.getElementById('policy-overlay').style.display = 'none'; }

    // --- Ranking Functions ---
    async function openRanking() {
        document.getElementById('ranking-overlay').style.display = 'flex';
        const list = document.getElementById('ranking-list');
        list.innerHTML = 'Loading...';
        if (!db) { list.innerHTML = 'Offline Mode'; return; }
        
        try {
            const snap = await db.collection('rankings').orderBy('score', 'desc').limit(100).get();
            let html = '';
            let rank = 1;
            snap.forEach(doc => {
                const d = doc.data();
                html += `<div class="rank-row"><span class="rank-num">#${rank}</span><span class="rank-name">${d.name}</span><span class="rank-score">Â¥${d.score.toLocaleString()}</span></div>`;
                rank++;
            });
            list.innerHTML = html || 'No Data';
        } catch(e) {
            console.error(e);
            list.innerHTML = 'Load Failed';
        }
    }

    async function checkRanking(score) {
        if (!db) return;
        try {
            const snap = await db.collection('rankings').orderBy('score', 'desc').limit(100).get();
            let isRankIn = false;
            if (snap.size < 100) {
                isRankIn = true;
            } else {
                const last = snap.docs[snap.docs.length - 1].data();
                if (score > last.score) isRankIn = true;
            }

            if (isRankIn) {
                document.getElementById('name-input-overlay').style.display = 'flex';
            }
        } catch(e) { console.error(e); }
    }

    async function submitScore() {
        const nameInput = document.getElementById('player-name');
        const err = document.getElementById('name-err');
        let name = nameInput.value.trim() || 'No Name';
        
        const lowerName = name.toLowerCase();
        for (let w of NG_WORDS) {
            if (lowerName.includes(w)) {
                err.style.display = 'block';
                return;
            }
        }
        err.style.display = 'none';

        if(db) {
            try {
                await db.collection('rankings').add({
                    name: name,
                    score: finalScoreTemp,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch(e){ console.error(e); }
        }
        document.getElementById('name-input-overlay').style.display = 'none';
        openRanking();
    }
    // -------------------------

    function startGame() { Sound.init(); document.getElementById('title-screen').style.display='none'; turn=30; score=0; combo=0; level=1; resources={red:0, blue:0, green:0}; boostCount=3; recoverCount=3; isBoostActive=false; spawnEnemy(); updateUI(); }
    function spawnEnemy() { currentEnemy = ENEMY_DATA[Math.floor(Math.random() * ENEMY_DATA.length)]; }

    function battle(pType) {
        const eType = currentEnemy.id;
        const match = (eType==='white'||eType==='black')?(pType===eType?'adv':'ext'):(pType==='white'||pType==='black')?'ext':(pType===eType?'adv':((eType==='red'&&pType==='blue')||(eType==='blue'&&pType==='green')||(eType==='green'&&pType==='red')?'neu':'ext'));
        // Ver.90: Base 400
        let s = Math.floor(400 * (1 + level * 0.10)), r = 0;
        if(match==='adv'){ s=Math.floor(s*(1+combo*0.2)); r=3; } // Buzz +20%
        else if(match==='neu'){ s=Math.floor(s*0.6*(1+combo*0.1)); r=6; }
        else { s=Math.floor(s*0.2); r=9; }
        if(isBoostActive) s*=2;
        if(match!=='ext') combo++; else combo=0;
        if(pType==='white' || pType==='black'){ const share = r/3; resources.red+=share; resources.blue+=share; resources.green+=share; }
        else { resources[pType]+=r; }
        score+=s; turn--; level++;
        if(match==='adv'){ if(navigator.vibrate)navigator.vibrate(15); Sound.play(880, 0.1); if(Math.random()<0.12 && recoverCount<5){ recoverCount++; spawnCutIn("+TIME!"); }}
        else if(match==='ext'){ if(Math.random()<0.12 && boostCount<5){ boostCount++; spawnCutIn("+BOOST!"); }}
        isBoostActive=false; spawnEnemy(); if(turn<=0) showResult(); else updateUI();
    }

    function updateUI() {
        const s = UI_STRINGS[curLang];
        document.getElementById('ui-turn').innerText=turn; document.getElementById('ui-score').innerText=score.toLocaleString(); document.getElementById('ui-combo').innerText=combo;
        document.getElementById('ui-res-red').innerText=Math.floor(resources.red); document.getElementById('ui-res-blue').innerText=Math.floor(resources.blue); document.getElementById('ui-res-green').innerText=Math.floor(resources.green);
        // Ver.90: 30 resources = +1.0x
        const totalM = 1 + ((resources.red + resources.blue + resources.green) / 30);
        document.getElementById('ui-rate-red').innerText=`+${(resources.red/30).toFixed(2)}x`;
        document.getElementById('ui-rate-blue').innerText=`+${(resources.blue/30).toFixed(2)}x`;
        document.getElementById('ui-rate-green').innerText=`+${(resources.green/30).toFixed(2)}x`;
        document.getElementById('total-lbl').innerText=`${s.total}: x${totalM.toFixed(2)}`;
        document.getElementById('ui-level').innerText=level;
        document.getElementById('ui-boost-btn').innerText=`${s.boost} (L:${boostCount})`;
        document.getElementById('ui-boost-btn').className='btn-item'+(isBoostActive?' active':'');
        document.getElementById('ui-time-btn').innerText=`${s.time} (L:${recoverCount})`;
        ['red','blue','green','white','black'].forEach(type => {
            const eType = currentEnemy.id;
            const m = (eType==='white'||eType==='black')?(type===eType?'adv':'ext'):(type==='white'||type==='black')?'ext':(type===eType?'adv':((eType==='red'&&type==='blue')||(eType==='blue'&&type==='green')||(eType==='green'&&type==='red')?'neu':'ext'));
            let r=9, l=(m==='adv'?"Buzz":m==='neu'?"Keep":"Promo"); 
            if(m==='adv'){r=3} else if(m==='neu'){r=6}
            let bs = Math.floor(400 * (1 + level * 0.10)); if(m==='adv')bs=Math.floor(bs*(1+combo*0.2)); else if(m==='neu')bs=Math.floor(bs*0.6*(1+combo*0.1)); else bs=Math.floor(bs*0.2);
            if(isBoostActive) bs*=2;
            const isSpecialButton = (type==='white' || type==='black');
            const icon = isSpecialButton ? 'All ' : (type==='red'?'ğŸ”¥':(type==='blue'?'â„ï¸':'ğŸ€'));
            const dispVal = isSpecialButton ? r/3 : r;
            document.getElementById(`btn-score-${type}`).innerText=`+Â¥${bs.toLocaleString()}`;
            document.getElementById(`btn-lbl-${type}`).innerText=`${l} | ${icon}Promo+${dispVal}`;
            const c=(m==='adv'?'#f1c40f':(m==='neu'?'#fff':'#88ccff'));
            document.getElementById(`btn-score-${type}`).style.color=c; document.getElementById(`btn-lbl-${type}`).style.color=c;
        });
        document.getElementById('ui-enemy-icon').innerText=currentEnemy.icon; document.getElementById('ui-enemy-name').innerText=currentEnemy[curLang].name;
        document.getElementById('ui-comment').innerText=currentEnemy[curLang].comment; document.getElementById('enemy-box').style.borderColor=currentEnemy.color;
        document.getElementById('boost-fx').style.display=isBoostActive?'block':'none';
    }

    function useBooster(e) { if(isBoostActive){ isBoostActive=false; boostCount++; } else if(boostCount>0){ boostCount--; isBoostActive=true; Sound.play(880, 0.4); flashScreen('#fff'); spawnCutIn("BOOST!!"); } updateUI(); }
    function useRecover() { if(recoverCount>0){ recoverCount--; turn++; Sound.play(1046, 0.3); flashScreen('#88ccff'); spawnCutIn("EXTEND!"); } updateUI(); }
    function flashScreen(c){ const f=document.getElementById('flash-fx'); f.style.backgroundColor=c; f.classList.remove('flash-anim'); void f.offsetWidth; f.classList.add('flash-anim'); }
    function spawnCutIn(t){ const e=document.createElement('div'); e.className='cutin-text'; e.innerText=t; document.body.appendChild(e); setTimeout(()=>e.remove(),600); }

    function showResult() {
        const s = UI_STRINGS[curLang];
        const totalM = 1 + (resources.red + resources.blue + resources.green) / 30;
        finalScoreTemp = Math.floor(score * totalM);
        const bonusMoney = finalScoreTemp - score;
        document.getElementById('res-title').innerText = s.result;
        document.getElementById('share-btn').innerText = s.share;
        document.getElementById('back-btn').innerText = s.title;
        document.getElementById('res-final-lbl').innerText = s.resFinal;
        
        document.getElementById('ui-res-grid').innerHTML = `
            <div style="display:flex;justify-content:space-between"><span>${s.resBase}:</span><span>Â¥${score.toLocaleString()}</span></div>
            <div style="display:flex;justify-content:space-between;color:#ffd700"><span>${s.resBonus}:</span><span>+Â¥${bonusMoney.toLocaleString()}</span></div>
            <div style="margin:5px 0;border-top:1px solid #444"></div>
            <div style="color:#ef476f">ğŸ”¥ Passion: ${Math.floor(resources.red)}</div>
            <div style="color:#118ab2">â„ï¸ Cool: ${Math.floor(resources.blue)}</div>
            <div style="color:#06d6a0">ğŸ€ Chill: ${Math.floor(resources.green)}</div>
            <div style="margin:5px 0;border-top:1px solid #444"></div>
            <div style="text-align:right;color:#ffd700;font-weight:bold">Multiplier: x${totalM.toFixed(2)}</div>
        `;
        document.getElementById('ui-res-final').innerText = finalScoreTemp.toLocaleString();
        document.getElementById('result-overlay').style.display = 'flex';
        const hs = localStorage.getItem('cm_highscore_v1') || 0;
        if (finalScoreTemp > hs) { localStorage.setItem('cm_highscore_v1', finalScoreTemp); initHighScore(); }
        
        checkRanking(finalScoreTemp);
    }

    function backToTitle() { document.getElementById('result-overlay').style.display = 'none'; document.getElementById('title-screen').style.display = 'flex'; }
    function shareOnX(){ 
        const f = document.getElementById('ui-res-final').innerText;
        const txt = curLang === 'ja' 
            ? `ã€CHANNEL MASTERã€‘ä»Šå›ã®é…ä¿¡åç›Š: Â¥${f}ï¼ ä¼èª¬ã®é…ä¿¡è€…ã‚’ç›®æŒ‡ã›ï¼ #ChannelMaster #å€‹äººé–‹ç™º`
            : `I earned Â¥${f} in CHANNEL MASTER! Can you beat my record? #ChannelMaster #IndieGame`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(txt)}&url=${encodeURIComponent(window.location.href)}`, '_blank'); 
    }
    function initHighScore() { document.getElementById('title-hs').innerText = parseInt(localStorage.getItem('cm_highscore_v1') || 0).toLocaleString(); }
    window.onload = () => { initHighScore(); applyUI(); };
</script>
</body>
</html>
